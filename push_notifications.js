// ============================================================
// üîî SISTEMA DE NOTIFICACIONES PUSH
// ============================================================

class PushNotificationManager {
  constructor() {
    this.permission = 'default';
    this.isSupported = 'Notification' in window;
    this.activeNotifications = new Map();
    this.soundEnabled = true;
    this.notificationSound = null;
    this.config = {
      icon: 'üí∞',
      badge: 'üîî',
      vibrate: [200, 100, 200],
      requireInteraction: false,
      silent: false
    };
  }

  // üéµ Inicializar sonido de notificaci√≥n
  initSound() {
    // Puedes usar un archivo de audio o generar un beep
    this.notificationSound = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuFzvLZiTYIGGW59+ibUBELTaXh8bllHgg2jdXx0Y0yBilruvG5dCgINHXD6+2kUhQIUKLh8bNgHQc1k+b00H8pCCJdsOu4Zy8COl6v6bldIg05UZbl7a5iKQgtb7vu0Z0+CSlruvLEfTUGNl+u6bRXIAs4V6vn66ZRDAo4VKXf7q5eIwk1Ta3n8KlZEwo3VKXf7rJeIgs1Sq7n7qdaDQo3VKXf7rNeIQk1S67m7adaDAo3VKXf7bNeIQk1S67m7adaDAo2VKXf7bNeIgg0TK7m7ahaDQo2VKXf7bJdIgg0TK7m7ahbDQo2U6Xf7bJdIgg0TK7m7alZDAo2U6Tf7bNeIgg0Ta7m7ahaDQo2U6Xf7bNeIQk1Ta7m7ahaDQo2U6Xf7rJeIgg0TK3n7adZDAo1Uqbf7bJdIgg0Ta3m7adZDAo1UqXf7bJdIgg0Ta7m7KdZDAk1U6Xf7bJdIgg0Ta7l7KdZDAk1U6Xf7bJdIgg0Ta7m7KdZDAk1U6Xf7bJdIgg0Ta7m7KdZDAk1U6Xf7bJdIgg0Ta7m7KdZDAk1U6Xf7bJdIgg0Ta7m7KdZDAk1U6Xf7bJdIgg0Ta7m7KdZDAk1U6Xf7bJdIgg0Ta7m7KdZDAk1U6Xf7bJdIgg0Ta7m7KdZDAk1U6Xf7bJdIgg0Ta7m7KdZDAk1U6Xf7bJdIgg0Ta7m7KdZDAk1U6Xf7bJdIgg0TK7m7KdZDAk1U6Xf7bJdIgg0TK7m7KdZDAk1U6Xf7bJdIgg0TK7m7KdZDAk1U6Xf7bJdIgg0TK7m7KdZDAk1U6Xf7bJdIgg0TK7m7KdZDAk1U6Xf7bJdIgg0TK7m7KdZDAk1U6Xf7bJdIgg0TK7m7KdZDAk1U6Xf7bJdIgg0TK7m7KdZDAk1U6Xf7bJdIgg0TK7m7KdZDAk1U6Xf7bJdIgg0TK7m7KdZDAk1U6Xf7bJdIgg0TK7m7KdZDAk1U6Xf7bJdIgg0TK7m7KdZDAk1U6Xf7bJdIgg0TK7m7KdZDAk1U6Xf7bJdIgg0TK7m7KdZDAk=');
  }

  // ‚úÖ Verificar soporte y permisos
  async init() {
    if (!this.isSupported) {
      console.warn('‚ùå Las notificaciones push no son soportadas en este navegador.');
      return false;
    }

    this.initSound();
    
    // Verificar permiso actual
    this.permission = Notification.permission;

    // Si ya est√° concedido, todo listo
    if (this.permission === 'granted') {
      console.log('‚úÖ Notificaciones push habilitadas.');
      return true;
    }

    // Si est√° denegado, informar al usuario
    if (this.permission === 'denied') {
      console.warn('‚ö†Ô∏è Las notificaciones est√°n bloqueadas. Ve a configuraci√≥n del navegador.');
      return false;
    }

    // Si es default, no pedir permiso a√∫n (esperar interacci√≥n del usuario)
    return null;
  }

  // üì¢ Solicitar permiso (debe ser llamado por interacci√≥n del usuario)
  async requestPermission() {
    if (!this.isSupported) {
      return false;
    }

    try {
      const permission = await Notification.requestPermission();
      this.permission = permission;
      
      if (permission === 'granted') {
        console.log('‚úÖ Permiso de notificaciones concedido.');
        this.showTestNotification();
        return true;
      } else {
        console.warn('‚ö†Ô∏è Permiso de notificaciones denegado.');
        return false;
      }
    } catch (error) {
      console.error('Error al solicitar permiso:', error);
      return false;
    }
  }

  // üß™ Notificaci√≥n de prueba
  showTestNotification() {
    this.show({
      title: 'üéâ ¬°Notificaciones activadas!',
      body: 'Ahora recibir√°s alertas sobre cuotas vencidas y pr√≥ximas.',
      tag: 'test-notification'
    });
  }

  // üì£ Mostrar notificaci√≥n
  show(options) {
    if (!this.isSupported || this.permission !== 'granted') {
      console.warn('‚ö†Ô∏è No se pueden mostrar notificaciones. Permiso no concedido.');
      return null;
    }

    const {
      title = 'Sistema de Pr√©stamos',
      body = '',
      tag = `notif-${Date.now()}`,
      data = {},
      actions = [],
      requireInteraction = this.config.requireInteraction,
      silent = this.config.silent
    } = options;

    const notificationOptions = {
      body,
      icon: this.config.icon,
      badge: this.config.badge,
      tag,
      data,
      vibrate: this.config.vibrate,
      requireInteraction,
      silent,
      actions: actions.length > 0 ? actions : undefined
    };

    try {
      const notification = new Notification(title, notificationOptions);
      
      // Guardar referencia
      this.activeNotifications.set(tag, notification);

      // Reproducir sonido personalizado si no es silenciosa
      if (!silent && this.soundEnabled && this.notificationSound) {
        this.notificationSound.play().catch(e => console.log('No se pudo reproducir sonido:', e));
      }

      // Event handlers
      notification.onclick = () => {
        window.focus();
        notification.close();
        if (options.onClick) options.onClick(data);
      };

      notification.onclose = () => {
        this.activeNotifications.delete(tag);
        if (options.onClose) options.onClose();
      };

      notification.onerror = (error) => {
        console.error('Error en notificaci√≥n:', error);
        this.activeNotifications.delete(tag);
      };

      // Auto-cerrar despu√©s de 10 segundos si no requiere interacci√≥n
      if (!requireInteraction) {
        setTimeout(() => notification.close(), 10000);
      }

      return notification;
    } catch (error) {
      console.error('Error al crear notificaci√≥n:', error);
      return null;
    }
  }

  // üö® Notificaci√≥n de cuota vencida
  notifyCuotaVencida(cuota, cliente, diasVencidos) {
    return this.show({
      title: `‚ö†Ô∏è Cuota Vencida - ${cliente}`,
      body: `Cuota #${cuota.numero} de ${this.formatMoney(cuota.monto)} lleva ${diasVencidos} d√≠a(s) vencida.`,
      tag: `vencida-${cuota.id}`,
      requireInteraction: true,
      data: { tipo: 'vencida', cuotaId: cuota.id, prestamoId: cuota.prestamoId },
      onClick: (data) => this.handleNotificationClick(data)
    });
  }

  // üü° Notificaci√≥n de cuota pr√≥xima a vencer
  notifyCuotaProxima(cuota, cliente, diasRestantes) {
    return this.show({
      title: `‚è∞ Cuota Pr√≥xima - ${cliente}`,
      body: `Cuota #${cuota.numero} de ${this.formatMoney(cuota.monto)} vence en ${diasRestantes} d√≠a(s).`,
      tag: `proxima-${cuota.id}`,
      data: { tipo: 'proxima', cuotaId: cuota.id, prestamoId: cuota.prestamoId },
      onClick: (data) => this.handleNotificationClick(data)
    });
  }

  // üî¥ Notificaci√≥n de cuota vence HOY
  notifyCuotaHoy(cuota, cliente) {
    return this.show({
      title: `üî¥ VENCE HOY - ${cliente}`,
      body: `¬°Cuota #${cuota.numero} de ${this.formatMoney(cuota.monto)} vence hoy!`,
      tag: `hoy-${cuota.id}`,
      requireInteraction: true,
      data: { tipo: 'hoy', cuotaId: cuota.id, prestamoId: cuota.prestamoId },
      onClick: (data) => this.handleNotificationClick(data)
    });
  }

  // üí∞ Notificaci√≥n de abono registrado
  notifyAbono(monto, cliente, saldoRestante) {
    return this.show({
      title: `‚úÖ Abono Registrado - ${cliente}`,
      body: `Se registr√≥ abono de ${this.formatMoney(monto)}. Saldo restante: ${this.formatMoney(saldoRestante)}`,
      tag: `abono-${Date.now()}`,
      silent: false,
      data: { tipo: 'abono' }
    });
  }

  // üéâ Notificaci√≥n de pr√©stamo saldado
  notifyPrestamoSaldado(cliente, montoTotal) {
    return this.show({
      title: `üéâ ¬°Pr√©stamo Saldado! - ${cliente}`,
      body: `El pr√©stamo de ${this.formatMoney(montoTotal)} ha sido completamente pagado.`,
      tag: `saldado-${Date.now()}`,
      requireInteraction: false,
      data: { tipo: 'saldado' }
    });
  }

  // üîÑ Notificaci√≥n de resumen diario
  notifyResumenDiario(vencidas, proximas, total) {
    return this.show({
      title: `üìä Resumen del D√≠a`,
      body: `${vencidas} cuotas vencidas | ${proximas} pr√≥ximas a vencer | Total pendiente: ${this.formatMoney(total)}`,
      tag: 'resumen-diario',
      requireInteraction: false
    });
  }

  // üéØ Manejar clic en notificaci√≥n
  handleNotificationClick(data) {
    console.log('Click en notificaci√≥n:', data);
    
    // Aqu√≠ puedes navegar a la secci√≥n correspondiente
    if (data.prestamoId) {
      // Disparar evento personalizado para que main.js lo maneje
      window.dispatchEvent(new CustomEvent('notification-click', { 
        detail: data 
      }));
    }
  }

  // üíµ Formatear dinero
  formatMoney(amount) {
    return new Intl.NumberFormat('es-CO', {
      style: 'currency',
      currency: 'COP',
      minimumFractionDigits: 0
    }).format(Number(amount || 0));
  }

  // üîï Activar/desactivar sonido
  toggleSound(enabled) {
    this.soundEnabled = enabled;
    localStorage.setItem('pushNotificationsSound', enabled);
  }

  // üóëÔ∏è Cerrar todas las notificaciones activas
  closeAll() {
    this.activeNotifications.forEach(notification => notification.close());
    this.activeNotifications.clear();
  }

  // üìã Obtener estado
  getStatus() {
    return {
      supported: this.isSupported,
      permission: this.permission,
      enabled: this.permission === 'granted',
      soundEnabled: this.soundEnabled,
      activeCount: this.activeNotifications.size
    };
  }
}

// ============================================================
// üìÖ PROGRAMADOR DE NOTIFICACIONES
// ============================================================

class NotificationScheduler {
  constructor(pushManager) {
    this.pushManager = pushManager;
    this.intervals = {
      checkVencidas: null,      // Cada 30 minutos
      checkProximas: null,      // Cada 2 horas
      resumenDiario: null       // Una vez al d√≠a (9 AM)
    };
    this.lastChecks = {
      vencidas: null,
      proximas: null,
      resumen: null
    };
  }

  // ‚ñ∂Ô∏è Iniciar programador
  start(state) {
    this.stop(); // Detener cualquier intervalo previo
    
    // Revisar cuotas vencidas cada 30 minutos
    this.intervals.checkVencidas = setInterval(() => {
      this.checkCuotasVencidas(state);
    }, 30 * 60 * 1000);

    // Revisar cuotas pr√≥ximas cada 2 horas
    this.intervals.checkProximas = setInterval(() => {
      this.checkCuotasProximas(state);
    }, 2 * 60 * 60 * 1000);

    // Resumen diario a las 9 AM
    this.scheduleResumenDiario(state);

    // Ejecutar checks inmediatamente
    this.checkCuotasVencidas(state);
    this.checkCuotasProximas(state);

    console.log('‚úÖ Programador de notificaciones iniciado.');
  }

  // ‚èπÔ∏è Detener programador
  stop() {
    Object.keys(this.intervals).forEach(key => {
      if (this.intervals[key]) {
        clearInterval(this.intervals[key]);
        this.intervals[key] = null;
      }
    });
    console.log('‚èπÔ∏è Programador de notificaciones detenido.');
  }

  // üö® Revisar cuotas vencidas
  checkCuotasVencidas(state) {
    if (!state || !state.cuotasByPrestamo || !state.prestamosByUser) return;

    const hoy = dayjs().startOf('day');
    const notificadas = new Set(JSON.parse(localStorage.getItem('cuotasVencidasNotificadas') || '[]'));

    for (const prestamoId in state.prestamosByUser) {
      const prestamo = state.prestamosByUser[prestamoId];
      const cliente = state.clientsById?.[prestamo.clienteId];
      const cuotas = state.cuotasByPrestamo[prestamoId] || [];

      for (const cuota of cuotas) {
        if (cuota.pagada) continue;

        const fechaCuota = dayjs(cuota.vencimiento?.toDate?.() || cuota.vencimiento).startOf('day');
        const diasVencidos = hoy.diff(fechaCuota, 'day');

        // Solo notificar cuotas vencidas hace 1, 3, 7, 15, 30 d√≠as
        if (diasVencidos > 0 && [1, 3, 7, 15, 30].includes(diasVencidos)) {
          const notifKey = `${cuota.id}-${diasVencidos}`;
          
          if (!notificadas.has(notifKey)) {
            this.pushManager.notifyCuotaVencida(
              cuota,
              cliente?.nombre || 'Cliente',
              diasVencidos
            );
            
            notificadas.add(notifKey);
            localStorage.setItem('cuotasVencidasNotificadas', JSON.stringify([...notificadas]));
          }
        }
      }
    }

    this.lastChecks.vencidas = new Date();
  }

  // ‚è∞ Revisar cuotas pr√≥ximas
  checkCuotasProximas(state) {
    if (!state || !state.cuotasByPrestamo || !state.prestamosByUser) return;

    const hoy = dayjs().startOf('day');
    const notificadas = new Set(JSON.parse(localStorage.getItem('cuotasProximasNotificadas') || '[]'));

    for (const prestamoId in state.prestamosByUser) {
      const prestamo = state.prestamosByUser[prestamoId];
      const cliente = state.clientsById?.[prestamo.clienteId];
      const cuotas = state.cuotasByPrestamo[prestamoId] || [];

      for (const cuota of cuotas) {
        if (cuota.pagada) continue;

        const fechaCuota = dayjs(cuota.vencimiento?.toDate?.() || cuota.vencimiento).startOf('day');
        const diasRestantes = fechaCuota.diff(hoy, 'day');

        // Notificar si vence hoy
        if (diasRestantes === 0) {
          const notifKey = `${cuota.id}-hoy`;
          if (!notificadas.has(notifKey)) {
            this.pushManager.notifyCuotaHoy(cuota, cliente?.nombre || 'Cliente');
            notificadas.add(notifKey);
            localStorage.setItem('cuotasProximasNotificadas', JSON.stringify([...notificadas]));
          }
        }
        // Notificar 3 d√≠as antes
        else if (diasRestantes === 3) {
          const notifKey = `${cuota.id}-3dias`;
          if (!notificadas.has(notifKey)) {
            this.pushManager.notifyCuotaProxima(cuota, cliente?.nombre || 'Cliente', diasRestantes);
            notificadas.add(notifKey);
            localStorage.setItem('cuotasProximasNotificadas', JSON.stringify([...notificadas]));
          }
        }
        // Notificar 7 d√≠as antes
        else if (diasRestantes === 7) {
          const notifKey = `${cuota.id}-7dias`;
          if (!notificadas.has(notifKey)) {
            this.pushManager.notifyCuotaProxima(cuota, cliente?.nombre || 'Cliente', diasRestantes);
            notificadas.add(notifKey);
            localStorage.setItem('cuotasProximasNotificadas', JSON.stringify([...notificadas]));
          }
        }
      }
    }

    this.lastChecks.proximas = new Date();
  }

  // üìä Programar resumen diario
  scheduleResumenDiario(state) {
    const ahora = new Date();
    const proximoResumen = new Date();
    proximoResumen.setHours(9, 0, 0, 0);

    // Si ya pasaron las 9 AM, programar para ma√±ana
    if (ahora.getHours() >= 9) {
      proximoResumen.setDate(proximoResumen.getDate() + 1);
    }

    const msHastaResumen = proximoResumen - ahora;

    setTimeout(() => {
      this.enviarResumenDiario(state);
      
      // Reprogramar para el d√≠a siguiente
      setInterval(() => {
        this.enviarResumenDiario(state);
      }, 24 * 60 * 60 * 1000);
    }, msHastaResumen);

    console.log(`üìÖ Resumen diario programado para: ${proximoResumen.toLocaleString()}`);
  }

  // üì® Enviar resumen diario
  enviarResumenDiario(state) {
    if (!state) return;

    const hoy = dayjs().startOf('day');
    let vencidas = 0;
    let proximas = 0;
    let totalPendiente = 0;

    for (const prestamoId in state.prestamosByUser) {
      const cuotas = state.cuotasByPrestamo[prestamoId] || [];
      
      for (const cuota of cuotas) {
        if (cuota.pagada) continue;

        const fechaCuota = dayjs(cuota.vencimiento?.toDate?.() || cuota.vencimiento).startOf('day');
        const diff = fechaCuota.diff(hoy, 'day');
        const montoPendiente = (cuota.monto || 0) - (cuota.pagado_parcial || 0);

        if (diff < 0) {
          vencidas++;
          totalPendiente += montoPendiente;
        } else if (diff <= 7) {
          proximas++;
          totalPendiente += montoPendiente;
        }
      }
    }

    this.pushManager.notifyResumenDiario(vencidas, proximas, totalPendiente);
    this.lastChecks.resumen = new Date();
  }
}

// ============================================================
// üåê EXPORTAR PARA USO EN MAIN.JS
// ============================================================
export { PushNotificationManager, NotificationScheduler };
